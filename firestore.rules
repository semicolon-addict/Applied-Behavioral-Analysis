///////////////////////////////////////////////////
// Author: Shashank Kakad
// Inputs: Updated Firestore rules with Super Admin role support
// Outcome: Super Admin users have full system access alongside existing Admin role
// Short Description: Added isSuperAdmin() function and updated access rules for Super Admin RBAC
/////////////////////////////////////////////////////////////

/**
 * @file Firebase Security Rules for ABA Assessments Platform
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for user-specific data, with role-based access for administrative and clinical functions. It prioritizes data security by validating user identity, ownership, and role for all operations.
 * @data_structure
 *  - /users/{userId}: Stores individual user profiles.
 *  - /roles_admin/{userId}: Documents indicate admin privileges.
 *  - /users/{userId}/children/{childId}: Stores child data.
 *  - /users/{userId}/children/{childId}/assessments/{assessmentId}: Stores child assessment data.
 *  - /users/{userId}/children/{childId}/questionnaires/{questionnaireId}: Stores child questionnaire data.
 *  - /abllsr_data/{abllsrDataId}: Stores ABLLS-R assessment data.
 * @key_security_decisions
 *  - Super Admins have full system access including user and role management.
 *  - Clinicians can read/write data for children they are assigned to.
 *  - Parents (owners) can read/write data for their own children.
 *  - Admins have read access to most data for oversight but limited write access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    function isSuperAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin';
    }
    
    function isClinician() {
        // Check if the requesting user has the 'Clinician' role.
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Clinician';
    }
    
    // Check if the clinician is assigned to the child whose data is being accessed.
    function isClinicianAssignedToChild(userId, childId) {
        return isClinician() && get(/databases/$(database)/documents/users/$(userId)/children/$(childId)).data.clinicianId == request.auth.uid;
    }

    match /users/{userId} {
      allow read, write: if isOwner(userId) || isAdmin() || isSuperAdmin();
      allow list: if isAdmin() || isSuperAdmin();
    }

    match /roles_admin/{userId} {
      allow get: if isAdmin() || isSuperAdmin();
      allow list: if isSuperAdmin();
      allow create: if isAdmin() || isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    match /users/{userId}/children/{childId} {
      // Parents can access their own children's data.
      // Assigned clinicians can access the children's data they are assigned to.
      // Admins and Super Admins can read for oversight.
      allow read: if isOwner(userId) || isClinicianAssignedToChild(userId, childId) || isAdmin() || isSuperAdmin();
      allow list: if isOwner(userId) || isClinicianAssignedToChild(userId, childId) || isAdmin() || isSuperAdmin();
      allow write: if isOwner(userId) || isClinicianAssignedToChild(userId, childId) || isSuperAdmin();
    }

    match /users/{userId}/children/{childId}/assessments/{assessmentId} {
      // Parents can access their own children's assessments.
      // Assigned clinicians can access assessments for children they are assigned to.
      // Admins and Super Admins can read for oversight.
      allow read: if isOwner(userId) || isClinicianAssignedToChild(userId, childId) || isAdmin() || isSuperAdmin();
      allow list: if isOwner(userId) || isClinicianAssignedToChild(userId, childId) || isAdmin() || isSuperAdmin();
      allow write: if isOwner(userId) || isClinicianAssignedToChild(userId, childId) || isSuperAdmin();
    }

    match /users/{userId}/children/{childId}/questionnaires/{questionnaireId} {
      // Parents can create their own children's questionnaires.
      // Assigned clinicians, admins, and Super Admins can read them.
      allow read: if isOwner(userId) || isClinicianAssignedToChild(userId, childId) || isAdmin() || isSuperAdmin();
      allow list: if isOwner(userId) || isClinicianAssignedToChild(userId, childId) || isAdmin() || isSuperAdmin();
      allow create: if isOwner(userId) || isSuperAdmin();
      allow update, delete: if isSuperAdmin();
    }

    match /abllsr_data/{abllsrDataId} {
      allow read, write: if isAdmin() || isSuperAdmin();
      allow list: if isAdmin() || isSuperAdmin();
    }
  }
}
